name: Verify Launch

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  verify-launch:
    runs-on: ubuntu-latest
    env:
      SUPABASE_CONNECTION_STRING: ${{ secrets.SUPABASE_CONNECTION_STRING }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_PGCRYPTO_KEY: ${{ secrets.SUPABASE_PGCRYPTO_KEY }}
      ABR_GUID: ${{ secrets.ABR_GUID }}
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
      STRIPE_PRICE_FEATURED: ${{ secrets.STRIPE_PRICE_FEATURED }}
      STRIPE_PRICE_PRO: ${{ secrets.STRIPE_PRICE_PRO }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
      ZAI_BASE_URL: ${{ secrets.ZAI_BASE_URL }}
      LLM_DEFAULT_MODEL: ${{ secrets.LLM_DEFAULT_MODEL }}
      ALERTS_EMAIL_TO: ${{ secrets.ALERTS_EMAIL_TO }}
      ALERTS_SLACK_WEBHOOK_URL: ${{ secrets.ALERTS_SLACK_WEBHOOK_URL }}
      FEATURE_MONETIZATION_ENABLED: '1'
      NEXT_PUBLIC_FEATURE_MONETIZATION_ENABLED: '1'
      ENV_TARGET: staging
      ABN_FALLBACK_MAX_RATE: '0.15'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run AI launch gate
        run: npm run verify:launch

      - name: Upload launch artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verify-launch-${{ github.run_id }}
          path: |
            DOCS/launch_runs/launch-prod-*-ai-preflight.md
            DOCS/launch_runs/launch-prod-*-ai-preflight.json
