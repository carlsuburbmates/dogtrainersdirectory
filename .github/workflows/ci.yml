name: CI guardrails

on:
  push:
  pull_request:

jobs:
  data-guardrails:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ensure suburbs CSV matches SQL seed
        run: |
          set -euo pipefail
          python3 scripts/refresh_suburbs_csv.py
          git diff --exit-code data/suburbs_councils_mapping.csv
      - name: Ensure generated SSOT snapshots are in sync
        run: |
          set -euo pipefail
          python3 scripts/ssot_refresh.py
          git diff --exit-code DOCS/SSOT/_generated
      - name: Validate suburb import counts and distance sanity
        run: |
          python3 - <<'PY'
          import re
          from math import radians, sin, cos, atan2, sqrt

          sql = open('supabase/data-import.sql', encoding='utf-8').read().splitlines()

          def extract_insert_values(lines, table):
            start = None
            for i, line in enumerate(lines):
              if re.match(rf"^INSERT\\s+INTO\\s+{table}\\b", line, re.IGNORECASE):
                start = i + 1
                break
            assert start is not None, f"Missing INSERT INTO {table} in supabase/data-import.sql"

            values = []
            for line in lines[start:]:
              s = line.strip()
              if not s:
                continue
              values.append(s)
              if s.endswith(";"):
                break
            assert values and values[-1].endswith(";"), f"INSERT INTO {table} did not terminate with ';'"
            return values

          councils_values = extract_insert_values(sql, "councils")
          suburbs_values = extract_insert_values(sql, "suburbs")

          council_tuples = [v for v in councils_values if v.startswith("(")]
          suburb_tuples = [v for v in suburbs_values if v.startswith("(")]

          assert len(council_tuples) == 28, f"Expected 28 councils, got {len(council_tuples)}"
          assert len(suburb_tuples) == 138, f"Expected 138 suburbs, got {len(suburb_tuples)}"

          def haversine(p1, p2):
            lat1, lon1 = p1; lat2, lon2 = p2
            R = 6371.0
            dlat = radians(lat2 - lat1)
            dlon = radians(lon2 - lon1)
            a = sin(dlat/2)**2 + cos(radians(lat1)) * cos(radians(lat2)) * sin(dlon/2)**2
            c = 2 * atan2(sqrt(a), sqrt(1 - a))
            return R * c

          def parse_coords(tuple_line):
            # Example:
            # ('Fitzroy', 3065, -37.8010382, 144.9792611, (SELECT id FROM councils WHERE name = 'City of Yarra')),
            m = re.match(r"^\\('([^']+)'\\s*,\\s*\\d+\\s*,\\s*([\\-0-9.]+)\\s*,\\s*([\\-0-9.]+)\\s*,", tuple_line)
            assert m, f"Could not parse suburb tuple: {tuple_line}"
            return m.group(1), (float(m.group(2)), float(m.group(3)))

          coords = dict(parse_coords(t) for t in suburb_tuples)
          for suburb in ("Fitzroy", "Brighton"):
            assert suburb in coords, f"Missing suburb in data-import.sql: {suburb}"

          dist = haversine(coords["Fitzroy"], coords["Brighton"])

          # Allow small drift due to coordinate updates
          assert 9.0 <= dist <= 13.5, f"Expected Fitzroy->Brighton ~12km (+/-), got {dist:.2f} km"
          print('Import counts and distance checks passed.')
          PY

  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Scan for leaked Stripe keys/secrets
        run: |
          set -euo pipefail
          files=$(git ls-files)
          if rg --hidden --no-ignore -g '*' "sk_live_|sk_test_|whsec_" $files; then
            echo "Found potential Stripe secrets in tracked files."
            exit 1
          else
            echo "Secret scan passed (no Stripe keys/webhook secrets in tracked files)."
          fi

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Run ESLint
        run: npm run lint

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: TypeScript type check
        run: npm run type-check

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Run unit tests
        run: npm test
      - name: Run smoke tests
        run: npm run smoke

  validate-import:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Validate import map
        run: npm run validate-import
